<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sourdough Field Notes v3.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Georgia&display=swap" rel="stylesheet">
    <style>
        :root { --bg-warm: #F0EDE6; --field-rust: #855C3D; --field-slate: #4A5568; --field-forest: #2D3748; }
        body { background-color: var(--bg-warm); font-family: 'Quicksand', sans-serif; color: var(--field-slate); }
        .serif { font-family: 'Georgia', serif; }
        .card { background: white; border-radius: 4px; border: 1px solid #D1CDC4; box-shadow: 2px 2px 0px rgba(0,0,0,0.05); margin-bottom: 1.25rem; }
        input, select, textarea { border: 1px solid #D1CDC4 !important; border-radius: 2px !important; padding: 10px; width: 100%; font-size: 16px !important; }
        label { font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; display: block; color: var(--field-rust); }
        .btn-primary { background-color: var(--field-forest); color: white; padding: 1rem; border-radius: 4px; font-weight: bold; width: 100%; }
        .btn-secondary { border: 1px solid var(--field-forest); color: var(--field-forest); padding: 0.75rem; border-radius: 4px; font-weight: bold; width: 100%; margin-top: 1rem; }
        .btn-edit { color: var(--field-rust); font-size: 11px; font-weight: 800; text-transform: uppercase; text-decoration: underline; }
        .formula-badge { background: #E2E8F0; font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; font-weight: bold; color: var(--field-forest); }
        .section-header { font-size: 12px; font-weight: 800; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 6px; margin-bottom: 12px; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto pb-10">

    <header class="mb-6 text-center">
        <h1 class="serif text-3xl font-bold text-[#3d2b1f]">Sourdough <span class="text-[#855c3d]">Field Notes</span></h1>
    </header>

    <div id="formView">
        <div class="card p-4">
            <h2 class="section-header">Timeline</h2>
            <div class="grid grid-cols-2 gap-4">
                <div><label>Mix Date</label><input type="date" id="mixDate"></div>
                <div><label>Bake Date</label><input type="date" id="bakeDate"></div>
            </div>
        </div>

        <div class="card p-4">
            <div class="flex justify-between items-center mb-3">
                <h2 class="section-header !mb-0">The Mix</h2>
                <div id="totalHydration" class="formula-badge">Hydration: 0%</div>
            </div>
            <label>Flours</label>
            <div id="flourContainer" class="space-y-2">
                <div class="flour-row flex items-center gap-1">
                    <select class="flour-select w-2/3" onchange="calculateFormula()">
                        <option value="">Select Flour</option>
                        <optgroup label="Cairnspring"><option>Trailblazer (T85)</option><option>Exultant (T70)</option><option>Yecora Rojo</option></optgroup>
                        <optgroup label="Dry Storage"><option>Rouge de Bordeaux</option><option>White Sonora</option><option>Turkey Red</option></optgroup>
                        <optgroup label="King Arthur"><option>KA Bread</option><option>KA AP</option></optgroup>
                    </select>
                    <input type="number" class="flour-qty w-1/3" placeholder="Grams" oninput="calculateFormula()">
                </div>
            </div>
            <button onclick="addRow('flourContainer')" class="text-[10px] font-bold mt-2 text-rust uppercase">+ Add Flour</button>

            <div class="grid grid-cols-2 gap-4 mt-6">
                <div><label>1st Water</label><input type="number" id="water1" oninput="calculateFormula()"></div>
                <div><label>2nd Water</label><input type="number" id="water2" oninput="calculateFormula()"></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <div><label>Salt</label><input type="number" id="salt"></div>
                <div><label>Yeast</label><input type="number" id="yeast"></div>
            </div>
        </div>

        <div class="card p-4">
            <h2 class="section-header">Levain</h2>
            <div class="grid grid-cols-2 gap-4">
                <div><label>Build Flour</label><input type="number" id="levBuildFlour" oninput="calculateFormula()"></div>
                <div><label>Build Water</label><input type="number" id="levBuildWater" oninput="calculateFormula()"></div>
            </div>
            <div class="mt-4"><label>Starter in Mix (g)</label><input type="number" id="levUsed" oninput="calculateFormula()"></div>
        </div>

        <button id="saveBtn" onclick="saveToCloud()" class="btn-primary">SYNC TO CLOUD</button>
        <button onclick="toggleView()" class="btn-secondary">VIEW LIBRARY</button>
    </div>

    <div id="libraryView" class="hidden">
        <h2 class="serif text-2xl mb-4 text-center">Batch History</h2>
        <div id="historyList" class="space-y-4"></div>
        <button onclick="toggleView()" class="btn-secondary">BACK TO MIXER</button>
    </div>

    <script>
        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbzr7ohfzwz8GIhFUQ3C5mg0v2k3MGai8JlxZU33xAsNoQsg36n6I5cgyfrh1N2u1C5yug/exec";

        function addRow(id) {
            const container = document.getElementById(id);
            const newRow = container.firstElementChild.cloneNode(true);
            newRow.querySelector('input').value = '';
            container.appendChild(newRow);
        }

        function toggleView() {
            document.getElementById('formView').classList.toggle('hidden');
            document.getElementById('libraryView').classList.toggle('hidden');
            if(!document.getElementById('libraryView').classList.contains('hidden')) loadHistory();
        }

        function calculateFormula() {
            let f = 0; document.querySelectorAll('.flour-qty').forEach(i => f += (parseFloat(i.value) || 0));
            const w = (parseFloat(document.getElementById('water1').value) || 0) + (parseFloat(document.getElementById('water2').value) || 0);
            const lbF = parseFloat(document.getElementById('levBuildFlour').value) || 0;
            const lbW = parseFloat(document.getElementById('levBuildWater').value) || 0;
            const lUsed = parseFloat(document.getElementById('levUsed').value) || 0;
            
            const ratio = lUsed / (lbF + lbW || 1);
            const totalF = f + (lbF * ratio);
            const totalW = w + (lbW * ratio);

            if (totalF > 0) document.getElementById('totalHydration').innerText = `Hydration: ${((totalW / totalF) * 100).toFixed(1)}%`;
        }

        async function saveToCloud() {
            const btn = document.getElementById('saveBtn'); btn.innerText = "SAVING...";
            let flourData = ""; document.querySelectorAll('.flour-row').forEach(r => {
                const n = r.querySelector('.flour-select').value;
                const q = r.querySelector('.flour-qty').value;
                if(q) flourData += `${n}(${q}g) `;
            });

            const entry = {
                mixDate: document.getElementById('mixDate').value,
                bakeDate: document.getElementById('bakeDate').value,
                flours: flourData,
                hydration: document.getElementById('totalHydration').innerText,
                water1: document.getElementById('water1').value,
                water2: document.getElementById('water2').value,
                salt: document.getElementById('salt').value,
                yeast: document.getElementById('yeast').value,
                levain: `Used:${document.getElementById('levUsed').value} Ratio:${document.getElementById('levBuildFlour').value}:${document.getElementById('levBuildWater').value}`
            };

            await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(entry) });
            alert("Entry Saved."); btn.innerText = "SYNC TO CLOUD";
        }

        async function loadHistory() {
            const list = document.getElementById('historyList'); list.innerHTML = "Loading...";
            const res = await fetch(CLOUD_URL);
            const data = await res.json();
            window.allBakes = data; // Store for editing
            list.innerHTML = data.reverse().map((item, index) => `
                <div class="card p-4">
                    <div class="flex justify-between">
                        <span class="text-[10px] font-bold text-rust uppercase">${item.MixDate}</span>
                        <span class="formula-badge">${item.Hydration}</span>
                    </div>
                    <p class="serif font-bold text-lg mt-1">${item.Flours}</p>
                    <button onclick="editBake(${data.length - 1 - index})" class="btn-edit mt-2">Edit Recipe</button>
                </div>
            `).join('');
        }

        function editBake(index) {
            const b = window.allBakes[index];
            document.getElementById('mixDate').value = b.MixDate;
            document.getElementById('bakeDate').value = b.BakeDate;
            document.getElementById('water1').value = b.Water1;
            document.getElementById('water2').value = b.Water2;
            document.getElementById('salt').value = b.Salt;
            document.getElementById('yeast').value = b.Yeast;
            // Parse Levain Used
            const match = b.Levain.match(/Used:(\d+)/);
            if(match) document.getElementById('levUsed').value = match[1];
            
            toggleView();
            calculateFormula();
        }
    </script>
</body>
</html>
